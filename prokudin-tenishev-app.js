javascript
// ====== ФУНКЦИЯ-ОБЕРТКА ДЛЯ ВТОРОГО ПРИЛОЖЕНИЯ (PROKUDIN/TENISHEV) ======
function initProkudinTenishevApp(sharedData) {
    let myMap = null; let cityCollection = null; let uyezdChoicesInstance = null; let activePlacemark = null; let provinceIndex = []; let prokudinItems = []; let tenishevItems = []; let allItems = [];
    const provincePolygons = new Map(); const prokudinPlacemarks = new Map(); const tenishevPlacemarks = new Map(); const uezdsByProvince = new Map(); const uyezdFeatures = [];
    const provincesCollection = new ymaps.GeoObjectCollection(null, { zIndex: 0 }); const prokudinCollection = new ymaps.GeoObjectCollection(null, { zIndex: 300 }); const tenishevCollection = new ymaps.GeoObjectCollection(null, { zIndex: 260 }); const uyezdCollection = new ymaps.GeoObjectCollection(null, { zIndex: 80 }); let uyezdCenterCollection = new ymaps.GeoObjectCollection(null, { zIndex: 100 });
    
    const initialCities = sharedData.initialCities;
    const uyezdCenterData = sharedData.uyezdCenterData;
    
    async function run(){
        const loaderBox = document.querySelector('#app-prokudin-tenishev .sidebar');
        const loaderText = document.getElementById('pgt-loader-status-text-sidebar');
        loaderBox.classList.add('is-loading');
        loaderText.textContent = "Инициализация карты...";
        myMap = new ymaps.Map('pgt-map', { center: [55.796, 49.108], zoom: 6, controls: ['zoomControl'] });
        myMap.geoObjects.add(provincesCollection).add(uyezdCollection).add(uyezdCenterCollection).add(tenishevCollection).add(prokudinCollection);
        
        const DRIVE_API_KEY = 'AIzaSyBExnfP9y79SpzJlYydrnNZ7WDOsxV0rDE';
        const PROKUDIN_KML_URL = 'https://cdn.jsdelivr.net/gh/Kudinov1982/history-map/prokudin-gorskiy.kml';
        const TENISHEV_KML_URL = 'https://cdn.jsdelivr.net/gh/Kudinov1982/history-map/tenishev.kml';
        const PROVINCES_GEOJSON = 'https://raw.githubusercontent.com/Kudinov1982/map/main/provinces_1897.geojson';
        const UYEZDS_GEOJSON = 'https://raw.githubusercontent.com/Kudinov1982/map/main/map_25022025.geojson';
        const TENISHEV_BOOKS = {"1":{title:"Том 1. Костромская и Тверская губернии.",folderId:"1AdQFYcIcqk7DRFWlwVM0ziZmTW4rdEeG",folderUrl:"https://drive.google.com/drive/folders/1AdQFYcIcqk7DRFWlwVM0ziZmTW4rdEeG?usp=drive_link",startPage:null,sortBy:"name",filenamePageRegex:/(\d{1,4})/},"2_2":{title:"Том 2. Ярославская губерния. Часть 2.",folderId:"1j1Sszzhw61Q5eZPKJH9HcykowBCc_CWK",folderUrl:"https://drive.google.com/drive/folders/1j1Sszzhw61Q5eZPKJH9HcykowBCc_CWK?usp=drive_link",startPage:null,sortBy:"name",filenamePageRegex:/(\d{1,4})/},"3":{title:"Том 3. Калужская губерния",folderId:"1LdNgp68RB1_koFOg9qSrnMEiCmVDJkKR",folderUrl:"https://drive.google.com/drive/folders/1LdNgp68RB1_koFOg9qSrnMEiCmVDJkKR?usp=sharing",startPage:null,sortBy:"name",filenamePageRegex:/(\d{1,4})/},"4":{title:"Том 4. Нижегородская губерния.",folderId:"1eIc7_ADR1FpwM7RWJ0pETujdKZybIeuD",folderUrl:"https://drive.google.com/drive/folders/1eIc7_ADR1FpwM7RWJ0pETujdKZybIeuD?usp=drive_link",startPage:null,sortBy:"name",filenamePageRegex:/(\d{1,4})/},"5_1":{title:"Том 5. Вологодская губерния. Часть 1",folderId:"13kdcdHeclQsRl5k-CIJwHe_VCnxzTQfZ",folderUrl:"https://drive.google.com/drive/folders/13kdcdHeclQsRl5k-CIJwHe_VCnxzTQfZ?usp=sharing",startPage:null,sortBy:"name",filenamePageRegex:/(\d{1,4})/},"6":{title:"Том 6. Курская, Московская, Олонецкая, Псковская, Санкт-Петербургская и Тульская губернии.",folderId:"1fL4qfotBB9ayeh-uz6zuwEcn1hnB2RxC",folderUrl:"https://drive.google.com/drive/folders/1fL4qfotBB9ayeh-uz6zuwEcn1hnB2RxC?usp=drive_link",startPage:null,sortBy:"name",filenamePageRegex:/(\d{1,4})/},"7_1":{title:"Том 7. Новгородская губерния. Часть 1",folderId:"1sXdcyNNlOp2QuJZHhmP68K-IT1eFWz0D",folderUrl:"https://drive.google.com/drive/folders/1sXdcyNNlOp2QuJZHhmP68K-IT1eFWz0D?usp=sharing",startPage:6,sortBy:"name",filenamePageRegex:/(\d{1,4})/}};
        function naturalCompare(a,b){return a.localeCompare(b,void 0,{numeric:!0,sensitivity:"base"})}function driveApiUrl(a){return`https://www.googleapis.com/drive/v3/files/${a}?alt=media&key=${DRIVE_API_KEY}`}function driveFallbackUrl(a){return`https://drive.google.com/uc?export=view&id=${a}`}window.pgtDriveFallbackUrl=driveFallbackUrl;function bookPageOffset(a){return"1"===a?1:"2_2"===a?4:"3"===a?4:"4"===a?0:"5_1"===a?3:"6"===a?2:"7_1"===a?3:0}function extractPrlibLink(a){if(!a)return null;const b=a.match(/\(часть\s*(\d+)\)/i);if(b&&b[1]){const c=b[1],d=new RegExp(`Часть ${c}.*?(https?://www\\.prlib\\.ru/item/\\d+)`,"i"),e=a.replace(/<br\s*\/?>/gi,"\n").match(d);if(e&&e[1])return e[1]}const c=a.match(/(https?:\/\/www\.prlib\.ru\/item\/\d+)/i);return c?c[1]:null}
        const searchInput=document.getElementById("pgt-search-input"),searchResultsContainer=document.getElementById("pgt-search-results"),provinceSelect=document.getElementById("pgt-province-filter"),uyezdSelect=document.getElementById("pgt-uyezd-filter"),chkProkudin=document.getElementById("pgt-filter-photo_prokudin"),chkTenishev=document.getElementById("pgt-filter-tenishev"),detailsPanel=document.getElementById("pgt-details-panel"),shareButton=document.getElementById("pgt-share-button"),provinceResetBtn=document.getElementById("pgt-province-reset-btn"),uyezdResetBtn=document.getElementById("pgt-uyezd-reset-btn");
        function createIconLayout(a,b=!1){const c=b?"custom-svg-icon is-highlighted":"custom-svg-icon";return ymaps.templateLayoutFactory.createClass(`<div class="${c}">${a||""}</div>`)}
        const EVENT_TYPE_CONFIG={photo_prokudin:{name:"Фотографии Прокудина-Горского",svg:'<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 24 24"><path fill="#111" d="M19 6.5h-1.28l-.32-1a3 3 0 0 0-2.84-2H9.44A3 3 0 0 0 6.6 5.55l-.32 1H5a3 3 0 0 0-3 3v8a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-8a3 3 0 0 0-3-3.05Zm1 11a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-8a1 1 0 0 1 1-1h2a1 1 0 0 0 1-.68l.54-1.64a1 1 0 0 1 .95-.68h5.12a1 1 0 0 1 .95-.68l.54 1.64a1 1 0 0 0 .9.68h2a1 1 0 0 1 1 1Zm-8-9a4 4 0 1 0 4 4a4 4 0 0 0-4-4Zm0 6a2 2 0 1 1 2-2a2 2 0 0 1-2 2Z"/></svg>'},tenishev:{name:"Тенишевские места",svg:'<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 24 24"><path fill="none" stroke="#0288D1" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0M3 6v13m9-13v13m9-13v13"/></svg>'}};
        const excludedGubIDs=new Set(["20","70","21","97","105","4","30","5","106","64","22","62a","70b","6","62b","70a","25","65","31","41","29","19","107","102","99","7","32","8","33","100","66","101","9","67","34","10","27","1","26","104","28","103","62"]);
        async function loadProvinces(){loaderText.textContent="Загрузка губерний…";const a=await fetch(PROVINCES_GEOJSON);if(!a.ok)throw new Error("GeoJSON HTTP "+a.status);const b=await a.json();provincesCollection.removeAll();provincePolygons.clear();b.features.forEach(c=>{const d=c.properties.prov_RU,e=String(c.properties.Gub_ID);if(!d||excludedGubIDs.has(e))return;let f=[];"Polygon"===c.geometry.type?f=[c.geometry.coordinates.map(g=>g.map(h=>[h[1],h[0]]))]:"MultiPolygon"===c.geometry.type&&(f=c.geometry.coordinates.map(g=>g.map(h=>h.map(i=>[i[1],i[0]]))));const j=new ymaps.Polygon([].concat(...f),{},{fillColor:"#20808C",strokeColor:"#eeeeee",strokeWidth:1.5,fillOpacity:.35,interactivityModel:"default#transparent"});provincesCollection.add(j);provincePolygons.set(d,j)});provinceIndex=Array.from(provincePolygons.entries()).map(([c,d])=>{const e=d.geometry.getBounds();return{name:c,polygon:d,bbox:{minLat:e[0][0],minLon:e[0][1],maxLat:e[1][0],maxLon:e[1][1]}}});const k=Array.from(provincePolygons.keys()).sort((c,d)=>c.localeCompare(d,"ru")),l=[{value:"",label:"Выберите губернию",selected:!0}].concat(k.map(c=>({value:c,label:c})));provinceSelect._choicesInstance&&provinceSelect._choicesInstance.destroy();provinceSelect._choicesInstance=new Choices(provinceSelect,{choices:l,searchEnabled:!0,itemSelectText:"",shouldSort:!1,allowHTML:!1,position:"bottom"});uyezdChoicesInstance&&uyezdChoicesInstance.destroy();uyezdChoicesInstance=new Choices(uyezdSelect,{choices:[{value:"",label:"Уезд (сначала выберите губернию)",selected:!0,disabled:!0}],searchEnabled:!0,itemSelectText:"",shouldSort:!1,allowHTML:!1,position:"bottom"});uyezdSelect.disabled=!0}
        function bboxContains(a,b,c){return b>=a.minLat&&b<=a.maxLat&&c>=a.minLon&&c<=a.maxLon}
        function addCityPlacemarks(){cityCollection||(cityCollection=new ymaps.GeoObjectCollection(null,{zIndex:100}),myMap.geoObjects.add(cityCollection));cityCollection.removeAll();const a=myMap.getZoom();initialCities.forEach(b=>{const c=7<=a||6<=a&&2>=b.priority||5<=a&&1===b.priority;if(!c)return;let d,e,f;switch(b.priority){case 1:d=5>=a?4:5;e=13;f=700;break;case 2:d=5>=a?3:4;e=12;f=500;break;default:d=6>=a?2.5:3.5,e=11,f=400}const g=2*d,h=`<svg xmlns="http://www.w3.org/2000/svg" width="${g}" height="${g}" viewBox="0 0 ${g} ${g}"><circle cx="${d}" cy="${d}" r="${d-.5}" fill="${1===b.priority?"#FF4136":"#FF851B"}" stroke="#fff" stroke-width="1" opacity="0.9"/></svg>`,i=new ymaps.Placemark([b.lat,b.lng],{iconContent:`<span class="map-label-text" style="font-size: ${e}px; font-weight: ${f};">${b.displayName||b.name}</span>`},{iconLayout:"default#imageWithContent",iconImageHref:"data:image/svg+xml;base64,"+btoa(h),iconImageSize:[g,g],iconImageOffset:[-d,-d],iconContentOffset:[d+4,-g+d-e/2],iconContentLayout:ymaps.templateLayoutFactory.createClass("$[properties.iconContent]"),hideIconOnBalloonOpen:!1,interactivityModel:"default#transparent"});cityCollection.add(i)})}
        async function loadProkudinKml(){loaderText.textContent="Загрузка: Прокудин-Горский…";const a=await fetch(PROKUDIN_KML_URL,{cache:"force-cache"});if(!a.ok)throw new Error("KML HTTP "+a.status);const b=(new DOMParser).parseFromString(await a.text(),"application/xml"),c=Array.from(b.getElementsByTagName("Placemark")),d=[];let e=1;for(const f of c){const g=f.getElementsByTagName("name")[0],h=f.getElementsByTagName("description")[0],i=f.getElementsByTagName("coordinates")[0];if(!g||!i)continue;const j=(g.textContent||"").trim(),[k,l]=(i.textContent||"").trim().split(",").map(m=>m.trim()),n=parseFloat(k),o=parseFloat(l);if(!isFinite(o)||!isFinite(n))continue;let p=h?h.textContent:"";let q="";if(p){const r=document.createElement("div");r.innerHTML=p;r.querySelectorAll("img").forEach(s=>{let t=(s.getAttribute("src")||"").trim();t.startsWith("/")&&(t="http://prokudin-gorskiy.ru"+t);let u=t.replace(/(\/library\/pg\/[^\/]+\/[^\/]+)([a-z])(\.(jpg|jpeg|png|gif))$/i,(v,w,x,y)=>"b"===x.toLowerCase()?v:`${w}b${y}`);const z=u.replace(/^https?:\/\//,"");s.src=`https://images.weserv.nl/?url=${z}`});const A=Array.from(r.querySelectorAll("a")).find(s=>s.href&&/prokudin-gorskiy\.ru\/image\.php/i.test(s.href));if(A)try{const s=new URL(A.href,"http://prokudin-gorskiy.ru");s.protocol="http:";s.hostname="prokudin-gorskiy.ru";q=s.toString();A.href=q;A.target="_blank"}catch(s){}p=r.innerHTML}d.push({id:e++,name:j,lat:o,lon:n,pageUrl:q,descriptionHtml:p,type:"photo_prokudin"})}prokudinItems=d}
        function buildProkudinBalloonHtml(a){const b=a.pageUrl?`<a href="${a.pageUrl}" target="_blank" class="custom-balloon__action-link">Открыть оригинал</a>`:"";return`<div class="custom-balloon"><div class="custom-balloon__body"><div class="custom-balloon__title">${a.name}</div><div class="custom-balloon__meta"><div class="custom-balloon__meta-item"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#6b7280" viewBox="0 0 16 16"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2z"/></svg><span>Фотографии Прокудина-Горского</span></div></div>${a.descriptionHtml||""}${b}</div></div>`}
        function ensureProkudinPlacemarks(){if(!prokudinItems.length)return;for(const a of prokudinItems){if(prokudinPlacemarks.has(a.id))continue;const b=createIconLayout(EVENT_TYPE_CONFIG.photo_prokudin.svg,!1),c=createIconLayout(EVENT_TYPE_CONFIG.photo_prokudin.svg,!0),d=new ymaps.Placemark([a.lat,a.lon],{balloonContent:'<div class="custom-balloon__body"><div class="custom-balloon__title">Загрузка…</div></div>',hintContent:a.name},{iconLayout:b,iconShape:{type:"Circle",coordinates:[14,14],radius:14},zIndex:300,hideIconOnBalloonOpen:!1});d.__normalLayout=b;d.__hiLayout=c;d.events.add("balloonopen",()=>{hideDetailsPanel();d.options.set("iconLayout",d.__hiLayout);d.properties.set("balloonContent",buildProkudinBalloonHtml(a))});d.events.add("balloonclose",()=>{d.options.set("iconLayout",d.__normalLayout)});prokudinPlacemarks.set(a.id,d);prokudinCollection.add(d)}}
        async function listDriveFolderFiles(a){if(!DRIVE_API_KEY)throw new Error("Не указан DRIVE_API_KEY");let b="";const c=[];do{const d=new URL("https://www.googleapis.com/drive/v3/files"),e={key:DRIVE_API_KEY,q:`'${a}' in parents and trashed=false`,fields:"nextPageToken, files(id,name,mimeType,createdTime,modifiedTime,size,thumbnailLink)",pageSize:1e3,includeItemsFromAllDrives:!0,supportsAllDrives:!0};Object.entries(e).forEach(([g,h])=>d.searchParams.set(g,h));b&&d.searchParams.set("pageToken",b);const f=await fetch(d.toString());if(!f.ok)throw new Error("Drive API HTTP "+f.status);const i=await f.json();Array.isArray(i.files)&&c.push(...i.files);b=i.nextPageToken||""}while(b);return c}
        async function buildBookIndex(a,b,c){const d=(await listDriveFolderFiles(a.folderId)).filter(e=>/^image\//.test(e.mimeType)||/\.jpe?g$|\.png$|\.webp$/i.test(e.name));if(!d.length)throw new Error("В папке нет изображений");let e=[...d];"createdTime"===a.sortBy?e.sort((g,h)=>new Date(g.createdTime)-new Date(h.createdTime)):e.sort((g,h)=>naturalCompare(g.name,h.name));const f=a.filenamePageRegex||/(\d{1,4})/,j=[];for(const g of e){const h=g.name.match(f);if(h){const i=parseInt(h[h.length-1]||h[1],10);Number.isFinite(i)&&j.push({page:i,file:g})}}let k={},l=[];if(j.length>=Math.ceil(e.length*.5)){for(const g of j)k[g.page]||(k[g.page]=g.file);l=Object.keys(k).map(g=>parseInt(g,10)).sort((g,h)=>g-h)}else{const m=Number.isFinite(a.startPage)?a.startPage:Number.isFinite(c)?c:1;let n=m;for(const g of e)k[n++]=g.file;l=Object.keys(k).map(g=>parseInt(g,10)).sort((g,h)=>g-h)}return{pageToId:k,pageNumbers:l,count:e.length}}
        function parseTenishevReference(a){const b=/Том\s+(\d+)/i.exec(a),c=b?parseInt(b[1],10):null;let d=null;const e=/\(часть\s*([0-9]+)\)/i.exec(a),f=/Часть\s*([0-9]+)/i.exec(a);e?d=parseInt(e[1],10):f&&(d=parseInt(f[1],10));let g=[];const h=/Стр\.?\s*(?:\(часть\s*\d+\)\s*)?([0-9,\s–—-]+)/i.exec(a);if(h){const i=h[1];i.split(/[,]/).forEach(j=>{const k=j.trim();if(!k)return;const l=k.split(/[–—-]/).map(m=>parseInt(m.trim(),10)).filter(Number.isFinite);1===l.length?g.push(l[0]):2<=l.length&&g.push(Math.min(l[0],l[1]))});g=g.filter(Number.isFinite)}return{volume:c,part:d,pages:g}}
        function resolveBookKey(a){if(a.volume&&Number.isFinite(a.part)){const b=`${a.volume}_${a.part}`;if(TENISHEV_BOOKS[b])return b}if(a.volume){const b=String(a.volume);if(TENISHEV_BOOKS[b])return b}return null}
        let tenishevBookMinRef={};async function loadTenishevKml(){loaderText.textContent="Загрузка: Тенишевские места…";const a=await fetch(TENISHEV_KML_URL,{cache:"force-cache"});if(!a.ok)throw new Error("KML HTTP "+a.status);const b=(new DOMParser).parseFromString(await a.text(),"application/xml"),c=Array.from(b.getElementsByTagName("Placemark")),d=[];let e=1;for(const f of c){const g=f.getElementsByTagName("name")[0],h=f.getElementsByTagName("description")[0],i=f.getElementsByTagName("coordinates")[0];if(!g||!i)continue;const j=(g.textContent||"").trim(),[k,l]=(i.textContent||"").trim().split(",").map(m=>m.trim()),n=parseFloat(k),o=parseFloat(l);if(!isFinite(o)||!isFinite(n))continue;const p=h?h.textContent:"",q=p.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),r=parseTenishevReference(q),s=resolveBookKey(r),t=Array.isArray(r.pages)&&r.pages.length?r.pages[0]:null;if(s&&Number.isFinite(t)){const u=tenishevBookMinRef[s];!Number.isFinite(u)||t<u&&(tenishevBookMinRef[s]=t)}d.push({id:e++,name:j,lat:o,lon:n,descriptionHtml:p,ref:r,bookKey:s,pageHint:t,type:"tenishev"})}tenishevItems=d}
        function findNearestAvailablePage(a,b){if(!a||!a.pageNumbers?.length)return null;if(a.pageToId[b])return b;const c=a.pageNumbers;let d=0,e=c.length-1;for(;d<=e;){const f=d+e>>1;if(c[f]===b)return c[f];c[f]<b?d=f+1:e=f-1}const g=[];d<c.length&&g.push(c[d]);0<=e&&g.push(c[e]);return g.length?(g.sort((h,i)=>Math.abs(h-b)-Math.abs(i-b)),g[0]):null}
        function hideDetailsPanel(){activePlacemark&&(activePlacemark.options.set("iconLayout",activePlacemark.__normalLayout),activePlacemark=null);detailsPanel.style.display="none";detailsPanel.innerHTML=""}
        function buildTenishevPanelContentHtml(a){const{ref:b,bookKey:c,pageHint:d,descriptionHtml:e}=a,f=c?TENISHEV_BOOKS[c]:null,g=extractPrlibLink(e);let h=`<div class="custom-balloon__meta"><div class="custom-balloon__meta-item"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0M3 6v13m9-13v13m9-13v13"/></svg><span>Тенишевские места</span></div>${b.volume||b.part||d?`<div class="custom-balloon__meta-item">${b.volume?"Том "+b.volume:""}${b.volume&&b.part?", ":""}${b.part?"Часть "+b.part:""}${b.volume||b.part&&d?", ":""}${d?"стр. "+d:""}</div>`:""}${g?`<div class="custom-balloon__meta-item" style="width: 100%; margin-top: 8px;">Оригинал издания: <a href="${g}" target="_blank" rel="noopener">Президентская библиотека</a></div>`:""}</div>`;if(!f)h+='<div class="custom-balloon__extract">Книга для этого места пока не сконфигурирована.</div>';else if(!f._index)h+=`<div class="custom-balloon__extract">Не удалось построить индекс книги. Откройте папку:</div><a href="${f.folderUrl}" target="_blank" class="custom-balloon__action-link">Открыть папку книги</a>`;else{const i=f._index,j=Number.isFinite(d)?d:i.pageNumbers[0],k=Number.isFinite(d)?d+bookPageOffset(c):i.pageNumbers[0],l=findNearestAvailablePage(i,k);if(null==l)h+='<div class="custom-balloon__extract">Страницы в папке не найдены.</div>';else{const m=i.pageToId[l],n=m.thumbnailLink||driveFallbackUrl(m.id),o=driveFallbackUrl(m.id);h+=`<div style="margin-top:8px;"><img src="${n}" alt="Страница файла ${l}" class="tenishev-preview" onerror="this.onerror=null; this.src='${o}';" onclick="window.openPgtViewer('${c}', ${k})" /></div>${l!==k?`<div class="custom-balloon__extract">Показан ближайший файл: ${l}${Number.isFinite(j)?` (по книге запрошена стр. ${j}${bookPageOffset(c)?` \u2192 \u0444\u0430\u0439\u043B = \u0441\u0442\u0440.+\u0441\u043C\u0435\u0449\u0435\u043D\u0438\u0435`:""})`:""}.</div>`:""}<button type="button" onclick="window.openPgtViewer('${c}', ${k})" class="custom-balloon__action-link" style="margin-top:10px;">Полноэкранный просмотр</button>`}}return h}
        function showTenishevDetailsInSidebar(a,b){hideDetailsPanel();b.options.set("iconLayout",b.__hiLayout);activePlacemark=b;const c=buildTenishevPanelContentHtml(a);detailsPanel.innerHTML=`<div class="details-header"><div class="details-title">${a.name}</div><button class="details-close-btn" title="\u0417\u0430\u043A\u0440\u044B\u0442\u044C">&times;</button></div><div class="details-body">${c}</div>`;detailsPanel.querySelector(".details-close-btn").addEventListener("click",hideDetailsPanel);detailsPanel.style.display="block"}
        function ensureTenishevPlacemarks(){if(!tenishevItems.length)return;for(const a of tenishevItems){if(tenishevPlacemarks.has(a.id))continue;const b=createIconLayout(EVENT_TYPE_CONFIG.tenishev.svg,!1),c=createIconLayout(EVENT_TYPE_CONFIG.tenishev.svg,!0),d=new ymaps.Placemark([a.lat,a.lon],{hintContent:a.name},{iconLayout:b,iconShape:{type:"Circle",coordinates:[14,14],radius:14},zIndex:260});d.__normalLayout=b;d.__hiLayout=c;d.events.add("click",e=>showTenishevDetailsInSidebar(a,e.get("target")));tenishevPlacemarks.set(a.id,d);tenishevCollection.add(d)}}
        function computeProvincesFor(a){if(!provinceIndex.length||!a.length)return;for(const b of a){const c=provinceIndex.filter(d=>bboxContains(d.bbox,b.lat,b.lon)),e=c.find(d=>d.polygon.geometry.contains([b.lat,b.lon]));e&&(b.province=e.name)}}
        async function loadUyezds(){loaderText.textContent="Загрузка: Уезды…";const a=await fetch(UYEZDS_GEOJSON,{cache:"force-cache"});if(!a.ok)throw new Error("Uyezds GeoJSON HTTP "+a.status);const b=await a.json();uyezdCollection.removeAll();uyezdFeatures.length=0;uezdsByProvince.clear();(b.features||[]).forEach((c,d)=>{const e=c.properties||{},f=e.Name_RU,g=e.prov_RU;if(!f||!g)return;const h=[];c.geometry&&"Polygon"===c.geometry.type?(c.geometry.coordinates||[]).forEach(i=>{h.push(i.map(j=>[j[1],j[0]]))}):c.geometry&&"MultiPolygon"===c.geometry.type?(c.geometry.coordinates||[]).forEach(i=>{(i||[]).forEach(j=>{h.push(j.map(k=>[k[1],k[0]]))})}):void 0;const l=new ymaps.Polygon(h,{name:f,prov:g,id:c.id??`_u_${d}`},{zIndex:80,fillColor:"#9aa8b5",fillOpacity:.18,strokeColor:"#eeeeee",strokeOpacity:.7,strokeWidth:1.5,interactivityModel:"default#transparent",visible:!0});uyezdCollection.add(l);const m=l.geometry.getBounds(),n={id:l.properties.get("id"),name:f,province:g,polygon:l,bbox:{minLat:m[0][0],minLon:m[0][1],maxLat:m[1][0],maxLon:m[1][1]}};uyezdFeatures.push(n);uezdsByProvince.has(g)||uezdsByProvince.set(g,[]);uezdsByProvince.get(g).push({id:n.id,name:n.name})})}
        function computeUyezdsFor(a){if(!a?.length||!uyezdFeatures.length)return;for(const b of a){let c=uyezdFeatures;if(b.province&&uezdsByProvince.has(b.province)){const d=new Set(uezdsByProvince.get(b.province).map(e=>e.name));c=uyezdFeatures.filter(e=>b.province===e.province&&d.has(e.name))}const f=c.filter(e=>bboxContains(e.bbox,b.lat,b.lon)),g=f.find(e=>e.polygon.geometry.contains([b.lat,b.lon]));g&&(b.uyezd=g.name)}}
        function populateUyezdFilter(a){if(!uyezdChoicesInstance)return;const b=[{value:"",label:"Все уезды",selected:!0}];if(!a||!uezdsByProvince.has(a)){uyezdChoicesInstance.setChoices([{value:"",label:"Уезд (сначала выберите губернию)",selected:!0,disabled:!0}],"value","label",!0);uyezdSelect.disabled=!0;return}const c=uezdsByProvince.get(a).slice().sort((d,e)=>d.name.localeCompare(e.name,"ru")).map(d=>({value:d.name,label:d.name}));uyezdChoicesInstance.clearStore();uyezdChoicesInstance.setChoices(b.concat(c),"value","label",!0);uyezdSelect.disabled=!1}
        function updateProkudinVisibility(){const a=chkProkudin.checked,b=provinceSelect.value,c=uyezdSelect.value;prokudinCollection.each(d=>d.options.set("visible",a));if(!a||!b&&!c)return;prokudinCollection.each(d=>d.options.set("visible",!1));for(const d of prokudinItems){const e=b?d.province===b:!0,f=c?d.uyezd===c:!0;if(e&&f){const g=prokudinPlacemarks.get(d.id);g&&g.options.set("visible",!0)}}}
        function updateTenishevVisibility(){const a=chkTenishev.checked,b=provinceSelect.value,c=uyezdSelect.value;tenishevCollection.each(d=>d.options.set("visible",a));if(!a||!b&&!c)return;tenishevCollection.each(d=>d.options.set("visible",!1));for(const d of tenishevItems){const e=b?d.province===b:!0,f=c?d.uyezd===c:!0;if(e&&f){const g=tenishevPlacemarks.get(d.id);g&&g.options.set("visible",!0)}}}
        function updateAllVisibility(){updateProkudinVisibility();updateTenishevVisibility();updateUyezdPolygonsVisibility()}
        function updateUyezdPolygonsVisibility(){const a=provinceSelect.value,b=uyezdSelect.value;for(const c of uyezdFeatures){let d=!0;a&&c.province!==a&&(d=!1);b&&c.name!==b&&(d=!1);c.polygon.options.set("visible",d)}}
        function updateUrlState(){const a=provinceSelect.value,b=uyezdSelect.value,c=[];chkProkudin.checked&&c.push(chkProkudin.value);chkTenishev.checked&&c.push(chkTenishev.value);const d=new URL(window.location);d.searchParams.delete("province");d.searchParams.delete("uyezd");d.searchParams.delete("layers");a&&d.searchParams.set("province",a);b&&d.searchParams.set("uyezd",b);0<c.length?d.searchParams.set("layers",c.join(",")):d.searchParams.set("layers","");window.history.replaceState({},"",d)}
        function handleProvinceChange(a={}){const{isInitial:b=!1,pan:c=!0}=a,d=provinceSelect.value;provincePolygons.forEach((e,f)=>{e.options.set("visible",!d||f===d)});populateUyezdFilter(d);uyezdChoicesInstance?uyezdChoicesInstance.setChoiceByValue(""):uyezdSelect.value="";c&&(d?(d=provincePolygons.get(d))&&myMap.setBounds(d.geometry.getBounds(),{checkZoomRange:!0,duration:b?0:700,zoomMargin:40}):myMap.setCenter([55.796,49.108],6,{duration:b?0:700}));provinceResetBtn.style.display=d?"block":"none";uyezdResetBtn.style.display="none";updateAllVisibility();addUyezdCenterLabels();hideDetailsPanel();updateUrlState();searchInput.value="";searchResultsContainer.innerHTML=""}
        function handleUyezdChange(a={}){const{isInitial:b=!1,pan:c=!0}=a,d=uyezdSelect.value;uyezdResetBtn.style.display=d?"block":"none";if(c&&d){const e=uyezdFeatures.find(f=>f.name===d&&f.province===provinceSelect.value);e&&myMap.setBounds(e.polygon.getBounds(),{checkZoomRange:!0,duration:b?0:700,zoomMargin:40})}updateAllVisibility();hideDetailsPanel();updateUrlState();searchInput.value="";searchResultsContainer.innerHTML=""}
        const ivModal=document.getElementById("pgt-iv-modal"),ivImg=document.getElementById("pgt-iv-image"),ivTitle=document.getElementById("pgt-iv-title"),ivCaption=document.getElementById("pgt-iv-caption"),ivOpenFolder=document.getElementById("pgt-iv-open-folder"),ivPrev=document.getElementById("pgt-iv-prev"),ivNext=document.getElementById("pgt-iv-next"),ivClose=document.getElementById("pgt-iv-close");let ivState={bookKey:null,currentPage:null,requestedPage:null};
        window.openPgtViewer=function(a,b){const c=TENISHEV_BOOKS[a];if(!c||!c._index)return;const d=c._index,e=findNearestAvailablePage(d,Number.isFinite(b)?b:d.pageNumbers[0]);if(null==e)return;ivState.bookKey=a;ivState.currentPage=e;ivState.requestedPage=b;const f=d.pageToId[e],g=driveApiUrl(f.id),h=driveFallbackUrl(f.id);ivImg.onerror=()=>{ivImg.onerror=null;ivImg.src=h};ivImg.src=g;ivTitle.textContent=c.title||`\u041A\u043D\u0438\u0433\u0430 ${a.replace("_"," \u0447. ")}`;ivCaption.textContent=`\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0444\u0430\u0439\u043B\u0430: ${e}`+(Number.isFinite(b)&&b!==e?` (\u0437\u0430\u043F\u0440\u043E\u0448\u0435\u043D\u0430: ${b})`:"");ivOpenFolder.href=c.folderUrl||"#";const i=d.pageNumbers,j=i.indexOf(e);ivPrev.disabled=0>=j;ivNext.disabled=0>j||j>=i.length-1;ivModal.classList.add("is-open");ivModal.setAttribute("aria-hidden","false")};
        ivClose.addEventListener("click",()=>{ivModal.classList.remove("is-open");ivModal.setAttribute("aria-hidden","true")});ivModal.addEventListener("click",a=>{a.target===ivModal&&ivClose.click()});document.addEventListener("keydown",a=>{"Escape"===a.key&&ivModal.classList.contains("is-open")&&ivClose.click()});ivPrev.addEventListener("click",()=>{const a=TENISHEV_BOOKS[ivState.bookKey];if(!a||!a._index)return;const b=a._index.pageNumbers,c=b.indexOf(ivState.currentPage);0<c&&window.openPgtViewer(ivState.bookKey,b[c-1])});ivNext.addEventListener("click",()=>{const a=TENISHEV_BOOKS[ivState.bookKey];if(!a||!a._index)return;const b=a._index.pageNumbers,c=b.indexOf(ivState.currentPage);0<=c&&c<b.length-1&&window.openPgtViewer(ivState.bookKey,b[c+1])});
        function addUyezdCenterLabels(){uyezdCenterCollection||(uyezdCenterCollection=new ymaps.GeoObjectCollection(null,{zIndex:100}),myMap.geoObjects.add(uyezdCenterCollection));uyezdCenterCollection.removeAll();const a=provinceSelect.value;if(!a||!uyezdCenterData[a])return;const b=getFontSizesForScreen(),c=uyezdCenterData[a];c.forEach(d=>{const e=d.position||"NE",f=3.5,g=2*f,h=700,i=b.uyezd,j=120;let k,l;"NW"===e?(k=-(j+f+.1),l="right"):(k=f+4,l="left");const m=-g+f-i/2,n=`<svg xmlns="http://www.w3.org/2000/svg" width="${g}" height="${g}" viewBox="0 0 ${g} ${g}"><circle cx="${f}" cy="${f}" r="${f-.5}" fill="#6c757d" stroke="#fff" stroke-width="1" opacity="0.9"/></svg>`,o=new ymaps.Placemark([d.lat,d.lng],{iconContent:`<div style="width:${j}px; text-align:${l};"><span class="map-label-text" style="font-family:'Montserrat',sans-serif; font-size:${i}px; font-weight:${h}; color:#333;">${d.displayName||d.name}</span></div>`},{iconLayout:"default#imageWithContent",iconImageHref:"data:image/svg+xml;base64,"+btoa(n),iconImageSize:[g,g],iconImageOffset:[-f,-f],iconContentOffset:[k,m],iconContentLayout:ymaps.templateLayoutFactory.createClass("$[properties.iconContent]"),hideIconOnBalloonOpen:!1,interactivityModel:"default#transparent"});uyezdCenterCollection.add(o)})}
        function updateLabels(){addCityPlacemarks();addUyezdCenterLabels()}
        myMap.events.add("boundschange",a=>{a.get("newZoom")!==a.get("oldZoom")&&updateLabels()});
        try{const a=new URLSearchParams(window.location.search),b=a.get("province"),c=a.get("uyezd"),d=a.get("layers");null!==d&&(d=new Set(d.split(",").filter(Boolean)),chkProkudin.checked=d.has("photo_prokudin"),chkTenishev.checked=d.has("tenishev"));await loadProvinces();await loadUyezds();addCityPlacemarks();await loadProkudinKml();await loadTenishevKml();computeProvincesFor(prokudinItems);computeProvincesFor(tenishevItems);computeUyezdsFor(prokudinItems);computeUyezdsFor(tenishevItems);allItems=[...prokudinItems,...tenishevItems];loaderText.textContent="Индексируем книги в Google Drive…";for(const e of Object.keys(TENISHEV_BOOKS))try{const f=TENISHEV_BOOKS[e];f._index=await buildBookIndex(f,e,tenishevBookMinRef[e])}catch(f){console.warn("Индекс книги не построен:",e,f.message);TENISHEV_BOOKS[e]._index=null}ensureProkudinPlacemarks();ensureTenishevPlacemarks();provinceSelect.addEventListener("change",()=>handleProvinceChange());uyezdSelect.addEventListener("change",()=>handleUyezdChange());provinceResetBtn.addEventListener("click",()=>{provinceSelect._choicesInstance&&(provinceSelect._choicesInstance.setChoiceByValue(""),handleProvinceChange())});uyezdResetBtn.addEventListener("click",()=>{uyezdChoicesInstance&&(uyezdChoicesInstance.setChoiceByValue(""),handleUyezdChange())});const j=()=>{updateAllVisibility();updateUrlState()};chkProkudin.addEventListener("change",j);chkTenishev.addEventListener("change",j);
        searchInput.addEventListener("input",()=>{const e=searchInput.value.trim().toLowerCase();if(3>e.length){searchResultsContainer.innerHTML="";return}const f=allItems.filter(g=>g.name.toLowerCase().includes(e)).slice(0,15);0<f.length?searchResultsContainer.innerHTML=f.map(g=>{const h=EVENT_TYPE_CONFIG[g.type]?.svg||"";return`<div class="search-result-item"><div class="search-result-icon">${h}</div><div class="search-result-text"><strong><a href="#" data-action="pan-to-point" data-id="${g.id}" data-type="${g.type}">${g.name}</a></strong><br><small>${g.province?`<a href="#" data-province="${g.province}">${g.province}</a>`:"Губерния не определена"}${g.uyezd?`, <a href="#" data-province="${g.province}" data-uyezd="${g.uyezd}">${g.uyezd}</a>`:""}</small></div></div>`}).join(""):searchResultsContainer.innerHTML='<div class="search-result-not-found">Ничего не найдено</div>'});
        searchResultsContainer.addEventListener("click",e=>{const f=e.target.closest("a");if(!f)return;e.preventDefault();const g=f.dataset.action;if("pan-to-point"===g){const h=parseInt(f.dataset.id,10),i=f.dataset.type,k=allItems.find(l=>l.id===h&&l.type===i);k&&(k.province&&provinceSelect.value!==k.province&&(provinceSelect._choicesInstance.setChoiceByValue(k.province),handleProvinceChange({pan:!1})),k.uyezd&&uyezdSelect.value!==k.uyezd&&setTimeout(()=>{uyezdChoicesInstance.setChoiceByValue(k.uyezd);handleUyezdChange({pan:!1})},100),e="tenishev"===k.type?chkTenishev:chkProkudin,e.checked||(e.checked=!0,j()),myMap.setCenter([k.lat,k.lon],12,{duration:500}).then(()=>{if("tenishev"===k.type){const l=tenishevPlacemarks.get(k.id);l&&showTenishevDetailsInSidebar(k,l)}else if("photo_prokudin"===k.type){const l=prokudinPlacemarks.get(k.id);l&&l.balloon.open()}}))}else{const h=f.dataset.province,i=f.dataset.uyezd;h&&provinceSelect._choicesInstance&&(provinceSelect._choicesInstance.setChoiceByValue(h),handleProvinceChange(),i&&uyezdChoicesInstance&&setTimeout(()=>{uyezdChoicesInstance.setChoiceByValue(i);handleUyezdChange()},100))}searchInput.value="";searchResultsContainer.innerHTML=""});
        myMap.events.add("click",hideDetailsPanel);shareButton.addEventListener("click",()=>{navigator.clipboard.writeText(window.location.href).then(()=>{const e=shareButton.querySelector("span"),f=e.textContent;shareButton.disabled=!0;e.textContent="Ссылка скопирована!";setTimeout(()=>{e.textContent=f;shareButton.disabled=!1},2500)}).catch(e=>{console.error("Не удалось скопировать ссылку: ",err);alert("Не удалось скопировать ссылку.")})});b&&provinceSelect._choicesInstance?(provinceSelect._choicesInstance.setChoiceByValue(b),handleProvinceChange({isInitial:!0}),c&&uyezdChoicesInstance&&setTimeout(()=>{uyezdChoicesInstance.setChoiceByValue(c);handleUyezdChange({isInitial:!0})},100)):updateAllVisibility();updateLabels()}catch(a){console.error(a);loaderText.textContent="Ошибка: "+(a?.message||a);return}finally{loaderBox.classList.remove("is-loading")}}
        
        run();
        return myMap;
    }
    
    return initProkudinTenishevApp;
}